<%- include('./partials/_header'); %>

<main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
      <h1 class="h2">Cuidados Paliativos</h1>
      <div class="btn-toolbar mb-2 mb-md-0">
      </div>
    </div>

<div class="form-group mb-3">
    <!-- Button trigger modal -->
<button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#exampleModal">
    Crear Nuevo Paciente
  </button>
</div>

<div class="table-responsive">
    <table id="example" class="table table-striped table-sm table-hover datatables">
        <thead>
            <tr>
                <th>Run</th>
                <th>Ficha</th>
                <th>Nombres</th>
                <th>Controles</th>
                <th>Dias Corridos</th>
                <th>Eva Ingreso</th>
                <th>Ps Ingreso</th>
                <th>Edad Ingreso</th>
                <th>Diagnostico</th>
                <th>Observaciones</th>
                <th>Acciones</th>
            </tr>
        </thead>
    <tbody>
        <% if(data) { %>
            <% for(var i=0; i < data.length; i++) { %>
                <tr>
                  <td><%= data[i].RunSinDV %></td>
                  <td><%= data[i].Ficha %></td>
                  <td><%= data[i].Nombres %></td>
                  <td><%= data[i].CantidadControles %></td>
                  <td><%= data[i].DiasCorridos %></td>
                  <td><%= data[i].EvaIngreso %></td>
                  <td><%= data[i].PsIngreso %></td>
                  <td><%= data[i].EdadIngreso %></td>
                  <td><%= data[i].Diagnostico %></td>
                  <td><%= data[i].Observaciones %></td>
                  <td><a href="profile/<%= data[i].RunSinDV %>" class="btn btn-primary btn-sm"><i class="fa-solid fa-user"></i></a>
                    <button type="button" class="btn btn-info btn-sm" onclick="abrirModal('<%= data[i].RunSinDV %>','<%= data[i].Nombres %>')">
                        <i class="fa-solid fa-user-clock"></i>
                      </button>
                    <a href="updatePatient/<%= data[i].RunSinDV %>" class="btn btn-warning btn-sm"><i class="fa-solid fa-user-pen"></i></a>
                      <button type="button" class="btn btn-danger btn-sm" onclick="modalEliminar('<%= data[i].RunSinDV %>', '<%= data[i].Nombres %>')">
                          <i class="fa-solid fa-user-xmark"></i>
                        </button>
                </td>
                </tr>
                <% } %>
        <%}%>
    </tbody>
  </table>
</div>
</main>

  <!-- Modal  agregar paciente-->
  <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Crear Nuevo Paciente</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form action="/addNewPatient" method="post">
            <div class="row">
                <div class="mb-3 col-md-12 div">
                    <label for="exampleInputEmail1" class="form-label">Ingrese Run para Buscar datos del paciente</label>
                    <input type="text" class="form-control" name="Run" id="Run" placeholder="Run sin DV" required>
                </div>
                <div class="mb-3 col-md-8 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Nombres</label>
                    <input type="text" class="form-control" name="Nombres" id="Nombres" readonly>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">N° de Ficha</label>
                    <input type="text" class="form-control" name="Ficha" id="Ficha" readonly>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Fecha de Nacimiento</label>
                    <input type="text" class="form-control" name="FechaNacimiento" id="FechaNacimiento" readonly>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Edad de Ingreso</label>
                    <input type="text" class="form-control" name="EdadIngreso" id="EdadIngreso" readonly>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Usuario Oncológico</label>
                    <input type="text" class="form-control" name="UsuarioOncologico" placeholder="UsuarioOncologico" required>
                </div>
                <div class="mb-3 col-md-8 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Domicilio</label>
                    <input type="text" class="form-control" name="Domicilio" id="Domicilio" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Lugar de Ingreso</label>
                    <input type="text" class="form-control" name="LugarIngreso" placeholder="LugarIngreso" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Fecha IPD</label>
                    <input type="date" class="form-control" name="FechaIPD" placeholder="FechaIPD" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Fecha Solicitud</label>
                    <input type="date" class="form-control" name="FechaSolicitud" placeholder="FechaSolicitud" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Fecha de Ingreso</label>
                    <input type="date" class="form-control" name="FechaIngreso" placeholder="FechaIngreso" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Eva Ingreso</label>
                    <input type="text" class="form-control" name="EvaIngreso" placeholder="EvaIngreso" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Ps Ingreso</label>
                    <input type="text" class="form-control" name="PsIngreso" placeholder="PsIngreso" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Diagnóstico</label>
                    <select name="Diagnostico" id="Diagnostico" class="form-control" required>
                        <option value="">Seleccione Diagnóstico</option>
                        <% if(dataDiagnosticos) { %>
                            <% for(var i=0; i < dataDiagnosticos.length; i++) { %>
                                <option value="<%= dataDiagnosticos[i].CodigoOrgano %>"><%= dataDiagnosticos[i].DescripcionOrgano %></option>
                                <% } %>
                        <%}%>
                    </select>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Medico Deriva</label>
                    <input type="text" class="form-control" name="MedicoDeriva" placeholder="MedicoDeriva" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Medico Ingresa</label>
                    <input type="text" class="form-control" name="MedicoIngresa" placeholder="MedicoIngresa" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Paciente Presente</label>
                    <input type="text" class="form-control" name="PacientePresente" placeholder="PacientePresente" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Conocimiento</label>
                    <input type="text" class="form-control" name="Conocimiento" placeholder="Conocimiento" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Comité</label>
                    <input type="text" class="form-control" name="Comite" placeholder="Comite" required>
                </div>
                <div class="mb-3 col-md-4 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Analgesia Previa</label>
                    <input type="text" class="form-control" name="AnalgesiaPrevia" placeholder="AnalgesiaPrevia" required>
                </div>
                <div class="mb-3 col-md-12 divDatos">
                    <label for="exampleInputEmail1" class="form-label">Observaciones</label>
                    <textarea class="form-control" name="Observaciones" placeholder="Observaciones" required></textarea>
                </div>
                <div class="alert alert-danger alert-dismissible fade show" role="alert" id="resultado">
                    <strong>No existe el paciente en la base de datos de Phoenix</strong>
                </div>
            </div>            
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          <button type="submit" class="btn btn-danger">Guardar</button>
        </div>        
    </form>
      </div>
    </div>
  </div>

<!-- Modal Controles -->
<div class="modal fade" id="modalAtenderPaciente" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Agregar Nuevo Control </h5> <br>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="/controls" method="post" class="row g-3">
                    <div class="form-group">
                        <label for="exampleInputEmail1" class="form-label">Nombres</label>
                        <input type="text" name="nombreControl" id="nombreControl" class="form-control" readonly>
                    </div>
                    <div class="form-group">
                        <label for="exampleInputEmail1" class="form-label">Tipo de Control</label>
                        <select name="tipoControl" id="tipoControl" class="form-control" required>
                            <option value="">Seleccione</option>
                            <option>Presencial</option>
                            <option>Visita Sala</option>
                            <option>Visita Domiciliaria</option>
                            <option>Control Telefónico</option>
                            <option>Telemedicina</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="exampleInputEmail1" class="form-label">Fecha del Control</label>
                        <input type="date" name="fechaControl" id="fechaControl" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="exampleInputEmail1" class="form-label">Observaciones</label>
                        <textarea name="observacionControl" id="observacionControl" class="form-control" required></textarea>
                    </div>
                    <input type="text" name="runControl" id="runControl" class="form-control" hidden>
                    <input type="text" name="runResponsable" id="runResponsable" class="form-control" value="17357806" hidden>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-danger">Guardar</button>
            </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Eliminar Paciente -->
<div class="modal fade" id="modalEliminarPaciente" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog mondal-danger">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Eliminar Paciente </h5> <br>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p id="mensajeEliminarPaciente"></p>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <a href="" class="btn btn-danger" id="linkEliminarPaciente">Eliminar</a>
            </div>
        </div>
    </div>
</div>

<script>
        function abrirModal(runPaciente, nombrePaciente){
        $("#nombreControl").val(nombrePaciente);
        $("#runControl").val(runPaciente);
        $('#modalAtenderPaciente').modal('show');
}

function modalEliminar(runPaciente, nombrePaciente){
        $("#mensajeEliminarPaciente").html('¿Estás seguro que deseas eliminar el paciente: <b>'+runPaciente + ' ' + nombrePaciente + '</b>');
        let link = "deletePatient/"+runPaciente
        $("#linkEliminarPaciente").attr("href", link);
        $('#modalEliminarPaciente').modal('show');
}
</script>

  <script>
    $(document).ready(function(){        
        $('#resultado').hide()
        $('.divDatos').hide()
        $("#Run").focusout(function () {
        let valor = $('#Run').val();
        $.ajax({
                type:'GET',
                url:'http://localhost:4000/validatePatient/'+valor, 
                dataType: "json",
                success:function(data){
                    if (data.message == "error") {
                        $('.divDatos').hide()
                        $('#resultado').show()
                    } else {
                        $('#resultado').hide()
                        $('.divDatos').show()
                        $('#Nombres').val(data.Nombres);
                        $('#Ficha').val(data.Ficha);
                        $('#FechaNacimiento').val(data.FechaNacimiento);
                        $('#EdadIngreso').val(data.Edad);
                        $('#Domicilio').val(data.Domicilio);
                        
                    }
                        
                }
            });
      });
    });
    </script>



  <%- include('./partials/_footer'); %>
